version: '3.8'

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped   
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    environment:
      - CF_API_EMAIL=jiwanaga@hotmail.com
      - CF_API_KEY=$CF_API_KEY      
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro    
      - traefikyaml:/etc/traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.entrypoints=http"
      - "traefik.http.routers.traefik.rule=Host(`traefik-dashboard.dajays.com`)"
#      - "traefik.http.middlewares.traefik-auth.basicauth.users=USER:BASIC_AUTH_PASSWORD"
      - "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.traefik.middlewares=traefik-https-redirect"
      - "traefik.http.routers.traefik-secure.entrypoints=https"
      - "traefik.http.routers.traefik-secure.rule=Host(`traefik-dashboard.dajays.com`)"
      - "traefik.http.routers.traefik-secure.middlewares=traefik-auth"
      - "traefik.http.routers.traefik-secure.tls=true"
      - "traefik.http.routers.traefik-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.traefik-secure.tls.domains[0].main=dajays.com"
      - "traefik.http.routers.traefik-secure.tls.domains[0].sans=*.dajays.com"
      - "traefik.http.routers.traefik-secure.service=api@internal"      
    networks:
      - net  
  
  nginx:
    image: nginx
    container_name: nginx
    ports:
      - 8181:80
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nginx.rule=Host(`nginx.dajays.com`)"
      - "traefik.http.routers.nginx.entrypoints=websecure"  
      - "traefik.http.routers.nginx.tls.certresolver=cloudflare"  
      - "traefik.http.routers.nginx.tls=true"
      - "traefik.http.routers.nginx.tls.domains[0].main=dajays.com"          
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro      
    networks:
      - net  
    depends_on:
     - traefik

  whoami:
    image: "traefik/whoami"
    container_name: "simple-service"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.dajays.com`)"
      - "traefik.http.routers.whoami.entrypoints=websecure"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro      
    networks:
      - net  
    depends_on:
     - traefik

volumes:
  traefikyaml:
    driver: local
    driver_opts:
      type: nfs
      o: "addr=192.168.1.11,rw,noatime,rsize=8192,wsize=8192,tcp,timeo=14,nfsvers=4"
      device: ":/volume1/docker/traefik"  

#  traefik_conf:
#    driver: local
#    driver_opts:
#      type: nfs
#      o: "addr=192.168.1.11,rw,noatime,rsize=8192,wsize=8192,tcp,timeo=14,nfsvers=4"
#      device: ":/volume1/docker/traefik/conf"      

#  traefik_certs:
#    driver: local
#    driver_opts:
#      type: nfs
#      o: "addr=192.168.1.11,rw,noatime,rsize=8192,wsize=8192,tcp,timeo=14,nfsvers=4"
#      device: ":/volume1/docker/traefik/certs"  

networks:
# Network for all Services (across Projects)
  net:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 192.168.100.0/24
        gateway: 192.168.100.1

        